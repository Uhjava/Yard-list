<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trailer Yard Layout Manager</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='15'/><text y='75' font-size='70' fill='white' font-family='Arial, sans-serif'>üöõ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            .container {
                padding: 30px;
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 2em;
            }
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.95em;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        @media (min-width: 768px) {
            .controls {
                gap: 20px;
                padding: 20px;
                margin-bottom: 30px;
            }
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 767px) {
            .control-group {
                flex: 1 1 100%;
            }
        }

        label {
            font-weight: 600;
            color: #555;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 80px;
            font-size: 14px;
        }

        button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            min-height: 44px;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            button {
                padding: 10px 20px;
                min-height: auto;
            }
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        @media (min-width: 768px) {
            .legend {
                gap: 15px;
                margin-bottom: 20px;
                padding: 15px;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        @media (min-width: 768px) {
            .legend-item {
                gap: 8px;
                padding: 5px 10px;
                font-size: 14px;
            }
        }

        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 5px;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .legend-color {
                width: 30px;
                height: 30px;
            }
        }

        .grid-container {
            overflow-x: auto;
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            gap: 8px;
            margin: 0 auto;
            width: fit-content;
        }

        .cell {
            width: 80px;
            height: 70px;
            border: 2px solid #495057;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            position: relative;
            font-size: 10px;
            text-align: center;
            padding: 4px;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            .cell {
                width: 100px;
                height: 80px;
                font-size: 11px;
                padding: 5px;
            }
        }

        @media (min-width: 1024px) {
            .cell:hover {
                transform: scale(1.05);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10;
            }
        }

        .cell.filled {
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .cell-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 3px;
        }

        .trailer-type-1room { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .trailer-type-2room { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .trailer-type-3room { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .trailer-type-office { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .trailer-type-wardrobe { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .trailer-type-hair { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .modal-content {
                padding: 30px;
                max-height: none;
                overflow-y: visible;
            }
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        @media (min-width: 768px) {
            .modal-content h2 {
                margin-bottom: 20px;
                font-size: 1.5em;
            }
        }

        .trailer-types {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .trailer-type-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            color: white;
            font-weight: 600;
            width: 100%;
            font-size: 14px;
            touch-action: manipulation;
        }

        @media (min-width: 768px) {
            .trailer-type-btn {
                font-size: 16px;
            }
        }

        @media (min-width: 1024px) {
            .trailer-type-btn:hover {
                transform: translateX(5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
        }

        .clear-btn {
            background: #dc3545;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .export-buttons {
                flex-direction: row;
            }
        }

        .export-buttons button {
            flex: 1;
            background: #28a745;
        }

        .export-buttons button:hover {
            background: #218838;
        }

        .row-label {
            position: absolute;
            left: -40px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #856404;
        }

        .unit-input-group {
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .unit-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
        }

        .unit-input-group select,
        .unit-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .unit-list-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .unit-list-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .unit-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .unit-input-container input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .unit-manager-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unit-manager-controls select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .unit-count {
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .cell-unit-label {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        @media (min-width: 768px) {
            .cell-unit-label {
                font-size: 14px;
            }
        }

        .draggable-units {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            min-height: 100px;
            border: 2px dashed #ddd;
        }

        .unit-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 20px;
            cursor: grab;
            user-select: none;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
            position: relative;
            touch-action: none;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .unit-bubble {
                padding: 10px 15px;
                font-size: 13px;
                min-height: auto;
            }
        }

        @media (min-width: 1024px) {
            .unit-bubble:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }
        }

        .unit-bubble:active {
            cursor: grabbing;
        }

        .unit-bubble.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .cell.drag-over {
            background: #e3f2fd !important;
            border: 3px dashed #2196F3 !important;
            transform: scale(1.05);
        }

        .unit-bubble.used {
            opacity: 0.5;
            background: linear-gradient(135deg, #999 0%, #666 100%);
            cursor: not-allowed;
        }

        .unit-bubble.used::after {
            content: '‚úì';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .trailer-type-selector {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .trailer-type-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .trailer-type-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Print Styles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .container {
                max-width: 100% !important;
                padding: 15px !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                background: white !important;
            }

            /* Hide interactive elements */
            .controls,
            .instructions,
            .unit-list-section,
            .export-buttons,
            #saveIndicator,
            .modal,
            button,
            input,
            select {
                display: none !important;
                visibility: hidden !important;
            }

            /* Header styling */
            h1 {
                font-size: 20pt !important;
                margin-bottom: 8pt !important;
                color: #000 !important;
                page-break-after: avoid !important;
                text-align: center !important;
            }

            .subtitle {
                font-size: 10pt !important;
                margin-bottom: 10pt !important;
                color: #333 !important;
                text-align: center !important;
            }

            /* Legend styling for print */
            .legend {
                display: flex !important;
                gap: 8px !important;
                flex-wrap: wrap !important;
                margin-bottom: 12pt !important;
                padding: 8pt !important;
                background: #f8f8f8 !important;
                border: 1px solid #333 !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                justify-content: center !important;
            }

            .legend-item {
                display: flex !important;
                align-items: center !important;
                gap: 5px !important;
                padding: 4pt 8pt !important;
                background: white !important;
                border: 1px solid #666 !important;
                border-radius: 3px !important;
                font-size: 9pt !important;
            }

            .legend-color {
                width: 18px !important;
                height: 18px !important;
                border: 2px solid #000 !important;
                flex-shrink: 0 !important;
            }

            /* Grid container */
            .grid-container {
                background: white !important;
                padding: 10pt !important;
                border: 2px solid #000 !important;
                page-break-inside: avoid !important;
                overflow: visible !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                margin: 0 auto !important;
            }

            .grid {
                display: grid !important;
                gap: 2px !important;
                margin: 0 auto !important;
                width: fit-content !important;
            }

            /* Grid cells for print */
            .cell {
                border: 2px solid #000 !important;
                border-radius: 2px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                background: white !important;
                position: relative !important;
                text-align: center !important;
                padding: 3px !important;
                page-break-inside: avoid !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
            }

            .cell.filled {
                font-weight: 700 !important;
                border: 2.5px solid #000 !important;
            }

            /* Ensure background colors print with !important */
            .trailer-type-1room { 
                background: #667eea !important;
            }
            .trailer-type-2room { 
                background: #f093fb !important;
            }
            .trailer-type-3room { 
                background: #4facfe !important;
            }
            .trailer-type-office { 
                background: #43e97b !important;
            }
            .trailer-type-wardrobe { 
                background: #fa709a !important;
            }
            .trailer-type-hair { 
                background: #30cfd0 !important;
            }

            .cell-unit-label {
                font-weight: 900 !important;
                color: #000 !important;
                background: rgba(255,255,255,0.9) !important;
                padding: 2px 4px !important;
                border-radius: 3px !important;
                line-height: 1.2 !important;
                margin-bottom: 2px !important;
            }

            .cell-label {
                color: #333 !important;
                font-size: 6pt !important;
                margin-top: 2px !important;
                background: rgba(255,255,255,0.7) !important;
                padding: 1px 2px !important;
                border-radius: 2px !important;
            }

            .row-label {
                position: absolute !important;
                left: -30px !important;
                font-weight: 700 !important;
                color: #000 !important;
                font-size: 9pt !important;
            }

            /* Page setup */
            @page {
                margin: 0.4in !important;
                size: landscape !important;
            }

            /* Add date/time to print */
            .container::before {
                content: "Printed: " attr(data-print-date) !important;
                display: block !important;
                text-align: right !important;
                font-size: 8pt !important;
                color: #666 !important;
                margin-bottom: 8pt !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöõ Trailer Yard Layout Manager</h1>
        <p class="subtitle">Click any cell to assign a trailer type</p>

        <div class="instructions">
            <h3>üìã How to Use:</h3>
            <ul>
                <li>Set your yard dimensions (rows and columns)</li>
                <li>Select a trailer type from the dropdown</li>
                <li>Drag unit bubbles onto grid cells</li>
                <li><strong>Right-click or Shift+Click</strong> on any filled cell to clear it</li>
                <li>Save or print your layout when done</li>
            </ul>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="rows">Rows:</label>
                <input type="number" id="rows" min="1" max="20" value="5">
            </div>
            <div class="control-group">
                <label for="cols">Columns:</label>
                <input type="number" id="cols" min="1" max="20" value="8">
            </div>
            <button onclick="createGrid()">Update Grid</button>
            <button onclick="clearAllCells()" class="clear-btn">Clear All</button>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color trailer-type-1room"></div>
                <span>1 Room</span>
            </div>
            <div class="legend-item">
                <div class="legend-color trailer-type-2room"></div>
                <span>2 Rooms</span>
            </div>
            <div class="legend-item">
                <div class="legend-color trailer-type-3room"></div>
                <span>3 Rooms</span>
            </div>
            <div class="legend-item">
                <div class="legend-color trailer-type-office"></div>
                <span>Office</span>
            </div>
            <div class="legend-item">
                <div class="legend-color trailer-type-wardrobe"></div>
                <span>Wardrobe</span>
            </div>
            <div class="legend-item">
                <div class="legend-color trailer-type-hair"></div>
                <span>Hair & Makeup</span>
            </div>
        </div>

        <div class="unit-list-section">
            <h3 style="margin-bottom: 10px;">üéØ Drag & Drop Units onto Grid</h3>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Select a trailer type to see available units, then drag them onto the grid cells</p>
            
            <div class="trailer-type-selector">
                <label for="dragTrailerType">Filter by Trailer Type:</label>
                <select id="dragTrailerType" onchange="updateDraggableUnits()">
                    <option value="1room">1 Room</option>
                    <option value="2room">2 Rooms</option>
                    <option value="3room">3 Rooms</option>
                    <option value="office">Office</option>
                    <option value="wardrobe">Wardrobe</option>
                    <option value="hair">Hair & Makeup</option>
                </select>
            </div>
            
            <div class="draggable-units" id="draggableUnits">
                <!-- Units will be populated here -->
            </div>
        </div>

        <div class="grid-container">
            <div id="grid" class="grid"></div>
        </div>

        <div class="export-buttons">
            <button onclick="saveLayout()">üíæ Download Layout File</button>
            <button onclick="printLayout()">üñ®Ô∏è Print Layout</button>
        </div>
        
        <div id="saveIndicator" style="position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-weight: 600;">
            ‚úì Auto-saved
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2>Select Trailer Type</h2>
            <div class="trailer-types">
                <button class="trailer-type-btn trailer-type-1room" onclick="selectTrailer('1room')">1 Room Trailer</button>
                <button class="trailer-type-btn trailer-type-2room" onclick="selectTrailer('2room')">2 Rooms Trailer</button>
                <button class="trailer-type-btn trailer-type-3room" onclick="selectTrailer('3room')">3 Rooms Trailer</button>
                <button class="trailer-type-btn trailer-type-office" onclick="selectTrailer('office')">Office Trailer</button>
                <button class="trailer-type-btn trailer-type-wardrobe" onclick="selectTrailer('wardrobe')">Wardrobe Trailer</button>
                <button class="trailer-type-btn trailer-type-hair" onclick="selectTrailer('hair')">Hair & Makeup</button>
            </div>
            <div class="unit-input-group">
                <label for="unitSearch">Search Unit:</label>
                <input type="text" id="unitSearch" placeholder="Type to search units..." oninput="filterUnits()">
                <label for="unitSelect" style="margin-top: 10px;">Select Unit (Optional):</label>
                <select id="unitSelect" size="5">
                    <option value="">-- No Label --</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button onclick="clearCell()" class="clear-btn">Clear Cell</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let selectedCell = null;
        let gridData = {};
        
        // Organize units by trailer type
        let unitsByType = {
            '1room': [
                'GST 01-01', 'GST 01-02', 'GST 01-03', 'GST 01-04', 'GST 01-05', 'GST 01-06', 
                'GST 01-07', 'GST 01-08', 'GST 01-09', 'GST 01-10', 'GST 01-11', 'GST 01-12', 
                'GST 01-13', 'GST 01-15', 'GST 01-16',
                'GST 05-02', 'GST 05-03', 'GST 05-04', 'GST 05-05',
                'GSR 01'
            ],
            '2room': [
                'GST 02-01', 'GST 02-02', 'GST 02-03', 'GST 02-04', 'GST 02-05', 'GST 02-06',
                'GST 02-07', 'GST 02-08', 'GST 02-09', 'GST 02-10', 'GST 02-11', 'GST 02-12',
                'GST 02-13', 'GST 02-14', 'GST 02-15', 'GST 02-16', 'GST 02-17', 'GST 02-18',
                'GST 02-19', 'GST 02-20', 'GST 02-21', 'GST 02-22', 'GST 02-23', 'GST 02-24',
                'GST 02-25', 'GST 02-26', 'GST 02-27', 'GST 02-28', 'GST 02-29', 'GST 02-30',
                'GST 02-31', 'GST 02-32', 'GST 02-33', 'GST 02-34', 'GST 02-35', 'GST 02-36'
            ],
            '3room': [
                'GST 03-01', 'GST 03-02', 'GST 03-03', 'GST 03-04', 'GST 03-05', 'GST 03-06',
                'GST 03-07', 'GST 03-08', 'GST 03-09', 'GST 03-10', 'GST 03-11', 'GST 03-12',
                'GST 03-13', 'GST 03-14', 'GST 03-15', 'GST 03-16', 'GST 03-17', 'GST 03-18',
                'GST 03-19', 'GST 03-20', 'GST 03-21', 'GST 03-22', 'GST 03-23', 'GST 03-24',
                'GST 03-25', 'GST 03-26', 'GST 03-27', 'GST 03-28', 'GST 03-29', 'GST 03-30',
                'GST 03-31', 'GST 03-32', 'GST 03-33', 'GST 03-34', 'GST 03-35', 'GST 03-36',
                'GST 03-37', 'GST 03-38', 'GST 03-39',
                'POP'
            ],
            'hair': [
                'GHM 08-01', 'GHM 08-02', 'GHM 08-03', 'GHM 08-04', 'GHM 08-05', 'GHM 08-06',
                'GHM 10-02', 'GHM 10-03', 'GHM 10-04', 'GHM 10-05', 'GHM 10-06', 'GHM 10-07',
                'GHM 10-08', 'GHM 10-09', 'GHM 10-10', 'GHM 10-11', 'GHM 10-12'
            ],
            'wardrobe': [
                'GWT 1', 'GWT 2', 'GWT 3', 'GWT 4', 'GWT 5', 'GWT 6', 'GWT 07',
                'GHW 01', 'GHW 02', 'GHW 03', 'GHW 04', 'GHW 06', 'GHW 07'
            ],
            'office': [
                'GOT 101', 'GOT 102', 'GOT 103', 'GOT 104', 'GOT 105', 'GOT 106',
                'G-EPS 01', 'G-EPS 02', 'G-EPS 03',
                'OT 123'
            ]
        };
        
        // Create flat list for backward compatibility
        let unitList = [];
        for (let type in unitsByType) {
            unitList = unitList.concat(unitsByType[type]);
        }

        const trailerNames = {
            '1room': '1 Room',
            '2room': '2 Rooms',
            '3room': '3 Rooms',
            'office': 'Office',
            'wardrobe': 'Wardrobe',
            'hair': 'Hair & Makeup'
        };

        function updateUnitDropdown() {
            const select = document.getElementById('unitSelect');
            select.innerHTML = '<option value="">-- No Label --</option>';
            
            unitList.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                select.appendChild(option);
            });
        }

        function updateDraggableUnits() {
            const container = document.getElementById('draggableUnits');
            const selectedType = document.getElementById('dragTrailerType').value;
            container.innerHTML = '';
            
            // Get list of units already placed
            const usedUnits = new Set();
            for (let cellId in gridData) {
                if (gridData[cellId].unit) {
                    usedUnits.add(gridData[cellId].unit);
                }
            }
            
            // Only show units for the selected trailer type
            const unitsForType = unitsByType[selectedType] || [];
            
            if (unitsForType.length === 0) {
                container.innerHTML = '<p style="color: #999; padding: 20px;">No units available for this trailer type</p>';
                return;
            }
            
            unitsForType.forEach(unit => {
                const bubble = document.createElement('div');
                bubble.className = 'unit-bubble';
                bubble.textContent = unit;
                bubble.draggable = true;
                bubble.dataset.unit = unit;
                
                // Mark used units
                if (usedUnits.has(unit)) {
                    bubble.classList.add('used');
                    bubble.draggable = false;
                }
                
                bubble.addEventListener('dragstart', handleDragStart);
                bubble.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(bubble);
            });
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            e.dataTransfer.setData('unit', this.dataset.unit);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        function filterUnits() {
            const searchText = document.getElementById('unitSearch').value.toLowerCase();
            const select = document.getElementById('unitSelect');
            
            select.innerHTML = '<option value="">-- No Label --</option>';
            
            const filtered = unitList.filter(unit => 
                unit.toLowerCase().includes(searchText)
            );
            
            filtered.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                select.appendChild(option);
            });
            
            // If only one result (plus "No Label"), auto-select it
            if (filtered.length === 1) {
                select.selectedIndex = 1;
            }
        }

        function createGrid() {
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            const grid = document.getElementById('grid');
            
            // Responsive cell width based on screen size
            const isMobile = window.innerWidth < 768;
            const cellWidth = isMobile ? '80px' : '100px';
            grid.style.gridTemplateColumns = `repeat(${cols}, ${cellWidth})`;
            grid.innerHTML = '';

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    const cellId = `${r}-${c}`;
                    
                    if (c === 0) {
                        const rowLabel = document.createElement('div');
                        rowLabel.className = 'row-label';
                        rowLabel.textContent = `Row ${r + 1}`;
                        cell.appendChild(rowLabel);
                    }
                    
                    if (gridData[cellId]) {
                        cell.classList.add('filled', `trailer-type-${gridData[cellId].type}`);
                        if (gridData[cellId].unit) {
                            // Show only unit number if assigned
                            cell.innerHTML = `<div class="cell-unit-label">${gridData[cellId].unit}</div><div class="cell-label">Row ${r + 1}, Col ${c + 1}</div>`;
                        } else {
                            // Show trailer type if no unit assigned
                            cell.innerHTML = `<div>${trailerNames[gridData[cellId].type]}</div><div class="cell-label">Row ${r + 1}, Col ${c + 1}</div>`;
                        }
                    } else {
                        cell.innerHTML = `<div style="color: #adb5bd;">Empty</div><div class="cell-label">R${r + 1} C${c + 1}</div>`;
                    }
                    
                    // Add drag and drop event listeners
                    cell.addEventListener('dragover', handleDragOver);
                    cell.addEventListener('dragleave', handleDragLeave);
                    cell.addEventListener('drop', handleDrop);
                    
                    // Add click handler - shift+click or right-click to clear
                    cell.onclick = (e) => {
                        if (e.shiftKey && gridData[cellId]) {
                            clearSingleCell(r, c);
                        } else {
                            openModal(r, c);
                        }
                    };
                    
                    // Right-click to clear
                    cell.oncontextmenu = (e) => {
                        e.preventDefault();
                        if (gridData[cellId]) {
                            clearSingleCell(r, c);
                        }
                        return false;
                    };
                    
                    grid.appendChild(cell);
                }
            }
            
            // Auto-save when grid is updated (but only if not initial load)
            if (document.readyState === 'complete') {
                autoSave();
            }
        }

        function clearSingleCell(row, col) {
            const cellId = `${row}-${col}`;
            if (gridData[cellId]) {
                if (confirm(`Clear ${gridData[cellId].unit || 'this trailer'}?`)) {
                    delete gridData[cellId];
                    createGrid();
                    updateDraggableUnits();
                    autoSave();
                }
            }
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            this.classList.remove('drag-over');
            
            const unit = e.dataTransfer.getData('unit');
            const trailerType = document.getElementById('dragTrailerType').value;
            const row = parseInt(this.dataset.row);
            const col = parseInt(this.dataset.col);
            const cellId = `${row}-${col}`;
            
            if (unit) {
                gridData[cellId] = {
                    type: trailerType,
                    unit: unit
                };
                
                createGrid();
                updateDraggableUnits();
                autoSave();
            }
            
            return false;
        }

        function openModal(row, col) {
            selectedCell = { row, col };
            const cellId = `${row}-${col}`;
            
            // Reset search
            document.getElementById('unitSearch').value = '';
            filterUnits();
            
            // Pre-select the current unit if one exists
            const select = document.getElementById('unitSelect');
            if (gridData[cellId] && gridData[cellId].unit) {
                select.value = gridData[cellId].unit;
            } else {
                select.value = '';
            }
            
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            selectedCell = null;
        }

        function selectTrailer(type) {
            if (selectedCell) {
                const cellId = `${selectedCell.row}-${selectedCell.col}`;
                const unitSelect = document.getElementById('unitSelect');
                const selectedUnit = unitSelect.value;
                
                gridData[cellId] = {
                    type: type,
                    unit: selectedUnit || null
                };
                
                createGrid();
                updateDraggableUnits();
                closeModal();
                autoSave(); // Auto-save after changes
            }
        }

        function clearCell() {
            if (selectedCell) {
                const cellId = `${selectedCell.row}-${selectedCell.col}`;
                delete gridData[cellId];
                createGrid();
                updateDraggableUnits();
                closeModal();
                autoSave(); // Auto-save after changes
            }
        }

        function clearAllCells() {
            if (confirm('Are you sure you want to clear all trailers?')) {
                gridData = {};
                createGrid();
                updateDraggableUnits();
                autoSave(); // Auto-save after changes
            }
        }

        function saveLayout() {
            const dataStr = JSON.stringify({
                rows: document.getElementById('rows').value,
                cols: document.getElementById('cols').value,
                layout: gridData,
                units: unitList
            }, null, 2);
            
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trailer-yard-layout.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Layout saved! You can reload this file later.');
        }

        function printLayout() {
            // Add current date/time to container
            const container = document.querySelector('.container');
            const now = new Date();
            const dateStr = now.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            container.setAttribute('data-print-date', dateStr);
            
            // Calculate optimal cell size for print
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);
            
            // Available print space (landscape letter: 11" x 8.5" minus margins)
            // 11" - 0.8" margins = 10.2" = ~735 points
            // 8.5" - 0.8" margins = 7.7" = ~555 points
            const availableWidth = 10.2 * 72; // ~735 points
            const availableHeight = 7.2 * 72; // ~518 points (leaving more space for header/legend)
            
            // Account for row labels (30px on left)
            const rowLabelSpace = 30;
            const usableWidth = availableWidth - rowLabelSpace;
            
            // Calculate cell size based on grid dimensions
            const gapSize = 2;
            const maxCellWidth = (usableWidth - (gapSize * (cols - 1))) / cols;
            const maxCellHeight = (availableHeight - (gapSize * (rows - 1))) / rows;
            
            // Use the smaller dimension to ensure square cells that fit
            let cellSize = Math.floor(Math.min(maxCellWidth, maxCellHeight));
            
            // Set reasonable min/max bounds
            cellSize = Math.max(25, Math.min(cellSize, 70));
            
            // Calculate font sizes proportionally
            const unitFontSize = Math.max(7, Math.floor(cellSize / 5.5));
            const labelFontSize = Math.max(5, Math.floor(cellSize / 9));
            const rowLabelFontSize = Math.max(7, Math.floor(cellSize / 6));
            
            console.log(`Grid: ${rows}√ó${cols}, Cell size: ${cellSize}px, Unit font: ${unitFontSize}pt`);
            
            // Apply dynamic sizing
            const style = document.createElement('style');
            style.id = 'dynamic-print-style';
            style.textContent = `
                @media print {
                    .cell {
                        width: ${cellSize}px !important;
                        height: ${cellSize}px !important;
                    }
                    .cell-unit-label {
                        font-size: ${unitFontSize}pt !important;
                        padding: ${Math.max(1, cellSize / 20)}px ${Math.max(2, cellSize / 15)}px !important;
                    }
                    .cell-label {
                        font-size: ${labelFontSize}pt !important;
                    }
                    .row-label {
                        font-size: ${rowLabelFontSize}pt !important;
                        left: -${Math.min(30, cellSize / 2)}px !important;
                    }
                    .grid {
                        gap: ${gapSize}px !important;
                    }
                }
            `;
            
            // Remove old style if exists
            const oldStyle = document.getElementById('dynamic-print-style');
            if (oldStyle) oldStyle.remove();
            
            document.head.appendChild(style);
            
            // Small delay to ensure styles are applied
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Auto-save to browser storage
        function autoSave() {
            const data = {
                rows: document.getElementById('rows').value,
                cols: document.getElementById('cols').value,
                layout: gridData,
                unitsByType: unitsByType
            };
            localStorage.setItem('trailerYardLayout', JSON.stringify(data));
            
            // Show save indicator
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // Load from browser storage
        function autoLoad() {
            const saved = localStorage.getItem('trailerYardLayout');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('rows').value = data.rows || 5;
                    document.getElementById('cols').value = data.cols || 8;
                    gridData = data.layout || {};
                    if (data.unitsByType) {
                        unitsByType = data.unitsByType;
                        // Rebuild flat unitList from unitsByType
                        unitList = [];
                        for (let type in unitsByType) {
                            unitList = unitList.concat(unitsByType[type]);
                        }
                    }
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            autoLoad(); // Load saved data first
            updateUnitDropdown();
            updateDraggableUnits();
            createGrid();
        });
    </script>
</body>
</html>
